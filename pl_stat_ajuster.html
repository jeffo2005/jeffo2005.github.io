<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width-device-width, initial-scale=1.0">
    <title>Premier League Stat Adjuster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    

<style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }
        .stat-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .result-card {
             background: linear-gradient(135deg, #1e3a8a, #3b82f6);
             color: white;
        }
        .dark .stat-card {
            background-color: #1e293b;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.5), 0 2px 4px -2px rgb(0 0 0 / 0.5);
        }
        .dark .result-card {
            background: linear-gradient(135deg, #1f2937, #4b5563);
        }
        .dark body {
            background-color: #111827;
        }
        .dark .text-slate-800 { color: #e2e8f0; }
        .dark .text-slate-900 { color: #f8fafc; }
        .dark .text-slate-600 { color: #94a3b8; }
        .dark .text-slate-500 { color: #64748b; }
    </style>
</head>
<body class="text-slate-800 bg-slate-50 dark:bg-slate-900 dark:text-slate-200">

    <header class="bg-white dark:bg-slate-800 shadow-sm">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold leading-tight text-slate-900 dark:text-white">Premier League Stat Adjuster</h1>
                <p class="mt-1 text-slate-500 dark:text-slate-400">Quantifying the "PL Tax": Translating player performance across Europe's top leagues.</p>
            </div>
            <button id="themeToggle" class="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 dark:focus:ring-slate-400 transition-colors duration-200">
                <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
                <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500 dark:text-slate-400 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">

            <div class="lg:col-span-3 space-y-8">
                <div class="stat-card bg-white dark:bg-slate-800">
                    <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-3">The Methodology Explained</h2>
                    <p class="text-slate-600 dark:text-slate-400">
                        This tool adjusts player statistics to estimate performance in the Premier League. The adjustment uses three core factors:
                    </p>
                    <ul class="list-disc list-inside mt-4 space-y-2 text-slate-600 dark:text-slate-400">
                        <li><span class="font-semibold">League Multiplier (LM):</span> Adjusts stats based on the difficulty gap between the original league (in its season) and the Premier League (in the target season).</li>
                        <li><span class="font-semibold">Playstyle Multiplier (PM):</span> A transparent, "Era-Adjusted" factor. It first adjusts a player's key stats for league difficulty, then compares them to PL benchmarks of the same era to assess their stylistic fit. The model amplifies the PM for outlier players.</li>
                        <li><span class="font-semibold">Potential Multiplier (PotM):</span> A subjective boost based on perceived potential for growth.</li>
                    </ul>
                     <p class="text-slate-600 dark:text-slate-400 mt-4">
                        The final adjusted stat is the raw stat multiplied by all three multipliers (LM, PM, and PotM) for a nuanced performance projection.
                    </p>
                </div>
            </div>
            
            <div class="lg:col-span-3 stat-card bg-white dark:bg-slate-800">
                <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Model Customization</h2>
                <p class="text-slate-600 dark:text-slate-400 mb-4">Adjust the sliders to change how the League Multiplier (LM) is calculated. The total weighting must be 100%.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="uefaWeight" class="block text-sm font-medium text-slate-700 dark:text-slate-300">UEFA Weighting: <span id="uefaWeightValue">70</span>%</label>
                        <input type="range" id="uefaWeight" min="0" max="100" value="70" class="mt-2 w-full">
                    </div>
                    <div>
                        <label for="compWeight" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Competitiveness Weighting: <span id="compWeightValue">30</span>%</label>
                        <input type="range" id="compWeight" min="0" max="100" value="30" class="mt-2 w-full">
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3 stat-card bg-white dark:bg-slate-800">
                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 text-center">League Difficulty Comparison</h2>
                 <p class="text-slate-600 dark:text-slate-400 text-center mb-6">These charts show the raw factors and the final calculated adjustment multiplier for each league relative to the Premier League.</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-medium text-slate-900 dark:text-white text-center mb-2">Normalized Difficulty Factors</h3>
                        <div class="chart-container">
                            <canvas id="factorsChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-slate-900 dark:text-white text-center mb-2">Final Adjustment Factor (vs PL)</h3>
                        <div class="chart-container">
                             <canvas id="adjustmentChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3 stat-card bg-white dark:bg-slate-800">
                <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Forward Projection Calculator</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                    <div class="space-y-4">
                         <div>
                            <label for="league" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Original League</label>
                            <select id="league" name="league" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md dark:bg-slate-700 dark:text-white dark:border-slate-600">
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label for="plYear" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Target PL Year</label>
                                <select id="plYear" name="plYear" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md dark:bg-slate-700 dark:text-white dark:border-slate-600">
                                    <option value="2025">2024-25</option>
                                    <option value="2024">2023-24</option>
                                    <option value="2023" selected>2022-23</option>
                                    <option value="2022">2021-22</option>
                                </select>
                            </div>
                            <div>
                                <label for="rawStatYear" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Raw Stat Year</label>
                                <select id="rawStatYear" name="rawStatYear" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md dark:bg-slate-700 dark:text-white dark:border-slate-600">
                                    <option value="2025">2024-25</option>
                                    <option value="2024">2023-24</option>
                                    <option value="2023" selected>2022-23</option>
                                    <option value="2022">2021-22</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="statType" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Stat Type</label>
                                <select id="statType" name="statType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md dark:bg-slate-700 dark:text-white dark:border-slate-600">
                                </select>
                            </div>
                             <div>
                                <label for="statValue" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Raw Stat Value</label>
                                <input type="number" name="statValue" id="statValue" step="0.01" value="0.50" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-slate-300 rounded-md dark:bg-slate-700 dark:text-white dark:border-slate-600">
                            </div>
                        </div>

                         <div class="mt-4">
                            <label for="position" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Player Position</label>
                            <select id="position" name="position" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md dark:bg-slate-700 dark:text-white dark:border-slate-600">
                                <option value="Forward">Forward</option>
                                <option value="Midfielder" selected>Midfielder</option>
                                <option value="Defender">Defender</option>
                            </select>
                        </div>
                        <div id="pmInputs" class="mt-6"></div>
                        
                        <div class="mt-4">
                             <label for="potential" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Player Potential: <span id="potentialValue">Average (1.00x)</span></label>
                             <input type="range" id="potential" min="1" max="5" value="3" class="mt-2 w-full">
                        </div>

                        <button id="calculateBtn" class="w-full mt-6 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Calculate Projection
                        </button>
                    </div>

                    <div id="result" class="result-card p-6 text-center flex flex-col justify-center items-center h-full min-h-[150px]">
                        <p class="text-lg font-medium text-blue-200">Adjusted Performance</p>
                        <p id="adjustedValue" class="text-4xl font-bold tracking-tight text-white">-</p>
                        <p id="equivalentText" class="text-blue-200">Select a stat to get its PL equivalent.</p>
                        <div class="mt-4 text-left w-full space-y-1">
                            <p class="text-sm">League Multiplier (LM): <span id="lmValue" class="font-bold text-amber-200">N/A</span></p>
                            <p class="text-sm">Playstyle Multiplier (PM): <span id="pmValue" class="font-bold text-amber-200">N/A</span></p>
                            <div id="pmBreakdown" class="ml-4 pl-2 border-l-2 border-amber-300 text-sm hidden"></div>
                            <p class="text-sm">Potential Multiplier (PotM): <span id="potmValue" class="font-bold text-amber-200">N/A</span></p>
                            <div id="potmBreakdown" class="ml-4 pl-2 border-l-2 border-amber-300 text-sm hidden"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reverse Calculator -->
            <div class="lg:col-span-3 stat-card bg-white dark:bg-slate-800">
                <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Reverse Calculator</h2>
                <p class="text-slate-600 dark:text-slate-400 mb-4">
                    Use this tool to find out what raw stats a player would need in another league to achieve a target performance in the Premier League. This uses the player profile (position, PM stats, potential) from the calculator above.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                    <div class="space-y-4">
                        <div>
                            <label for="targetStatValue" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Target PL Stat Value</label>
                            <input type="number" id="targetStatValue" step="0.01" value="0.50" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-slate-300 rounded-md dark:bg-slate-700 dark:text-white dark:border-slate-600">
                        </div>
                        <button id="calculateReverseBtn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            Calculate Required Raw Stat
                        </button>
                    </div>
                    <div id="reverseResult" class="bg-slate-100 dark:bg-slate-700 rounded-lg p-6 text-center h-full">
                        <p class="text-lg font-medium text-slate-500 dark:text-slate-300">Required Raw Stat</p>
                        <p id="requiredRawValue" class="text-4xl font-bold tracking-tight text-slate-900 dark:text-white">-</p>
                        <p id="requiredLeagueText" class="text-slate-500 dark:text-slate-400">in selected league.</p>
                        <div class="mt-4 text-left w-full space-y-1 text-sm text-slate-600 dark:text-slate-400">
                            <p>League Multiplier (LM): <span id="reverseLmValue" class="font-bold">N/A</span></p>
                            <p>Playstyle Multiplier (PM): <span id="reversePmValue" class="font-bold">N/A</span></p>
                            <div id="reversePmBreakdown" class="ml-4 pl-2 border-l-2 border-slate-300 dark:border-slate-500 text-xs hidden"></div>
                            <p>Potential Multiplier (PotM): <span id="reversePotmValue" class="font-bold">N/A</span></p>
                            <div id="reversePotmBreakdown" class="ml-4 pl-2 border-l-2 border-slate-300 dark:border-slate-500 text-xs hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-3 stat-card bg-white dark:bg-slate-800">
                <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Player Comparison Chart</h2>
                 <p class="text-slate-600 dark:text-slate-400 mb-4 text-center">This chart compares a selected player's performance to the top 5 players in the Premier League for that same stat in the target year.</p>
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

        </div>
    </main>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Data stores
        const leagueData = {
            'Premier League': {
                '2025': { uefaCoeff: 106.5, financialRatio: 1.0, color: 'rgba(59, 130, 246, 0.7)', intraComp: 0.021 },
                '2024': { uefaCoeff: 104.3, financialRatio: 1.0, color: 'rgba(59, 130, 246, 0.7)', intraComp: 0.021 },
                '2023': { uefaCoeff: 98.2, financialRatio: 1.0, color: 'rgba(59, 130, 246, 0.7)', intraComp: 0.021 },
                '2022': { uefaCoeff: 94.6, financialRatio: 1.0, color: 'rgba(59, 130, 246, 0.7)', intraComp: 0.021 },
            },
            'Serie A': {
                '2025': { uefaCoeff: 92.5, financialRatio: 0.52, color: 'rgba(16, 185, 129, 0.7)', intraComp: 0.017 },
                '2024': { uefaCoeff: 89.9, financialRatio: 0.52, color: 'rgba(16, 185, 129, 0.7)', intraComp: 0.017 },
                '2023': { uefaCoeff: 85.3, financialRatio: 0.52, color: 'rgba(16, 185, 129, 0.7)', intraComp: 0.017 },
                '2022': { uefaCoeff: 81.1, financialRatio: 0.52, color: 'rgba(16, 185, 129, 0.7)', intraComp: 0.017 },
            },
            'La Liga': {
                '2025': { uefaCoeff: 90.8, financialRatio: 0.52, color: 'rgba(239, 68, 68, 0.7)', intraComp: 0.019 },
                '2024': { uefaCoeff: 89.4, financialRatio: 0.52, color: 'rgba(239, 68, 68, 0.7)', intraComp: 0.019 },
                '2023': { uefaCoeff: 88.9, financialRatio: 0.52, color: 'rgba(239, 68, 68, 0.7)', intraComp: 0.019 },
                '2022': { uefaCoeff: 84.7, financialRatio: 0.52, color: 'rgba(239, 68, 68, 0.7)', intraComp: 0.019 },
            },
            'Bundesliga': {
                '2025': { uefaCoeff: 87.7, financialRatio: 0.49, color: 'rgba(245, 158, 11, 0.7)', intraComp: 0.020 },
                '2024': { uefaCoeff: 86.6, financialRatio: 0.49, color: 'rgba(245, 158, 11, 0.7)', intraComp: 0.020 },
                '2023': { uefaCoeff: 83.3, financialRatio: 0.49, color: 'rgba(245, 158, 11, 0.7)', intraComp: 0.020 },
                '2022': { uefaCoeff: 80.1, financialRatio: 0.49, color: 'rgba(245, 158, 11, 0.7)', intraComp: 0.020 },
            },
            'Ligue 1': {
                '2025': { uefaCoeff: 68.2, financialRatio: 0.28, color: 'rgba(139, 92, 246, 0.7)', intraComp: 0.015 },
                '2024': { uefaCoeff: 66.8, financialRatio: 0.28, color: 'rgba(139, 92, 246, 0.7)', intraComp: 0.015 },
                '2023': { uefaCoeff: 62.4, financialRatio: 0.28, color: 'rgba(139, 92, 246, 0.7)', intraComp: 0.015 },
                '2022': { uefaCoeff: 58.7, financialRatio: 0.28, color: 'rgba(139, 92, 246, 0.7)', intraComp: 0.015 },
            },
        };
        const topPLPlayersData = {
             '2025': {
                'Goals per 90': {
                    'Erling Haaland': 0.95, 'Darwin Nunez': 0.85, 'Cole Palmer': 0.82, 'Ollie Watkins': 0.75, 'Alexander Isak': 0.72
                },
                'xG per 90': {
                    'Erling Haaland': 0.91, 'Darwin Nunez': 0.88, 'Cole Palmer': 0.80, 'Alexander Isak': 0.75, 'Ollie Watkins': 0.73
                },
                'Assists per 90': {
                    'Kevin De Bruyne': 0.55, 'Bruno Fernandes': 0.51, 'Cole Palmer': 0.48, 'Leandro Trossard': 0.45, 'Martin Ødegaard': 0.44
                },
                'Progressive Passes per 90': {
                    'Rodri': 9.8, 'Kevin De Bruyne': 9.5, 'Bruno Guimarães': 9.1, 'Trent Alexander-Arnold': 8.9, 'Pascal Groß': 8.7
                },
                'Dribbles per 90': {
                    'Eberechi Eze': 4.0, 'Jérémy Doku': 3.9, 'Michael Olise': 3.6, 'Cole Palmer': 3.4, 'Bukayo Saka': 3.3
                },
                'Tackles per 90': {
                    'João Palhinha': 4.1, 'Bruno Guimarães': 3.9, 'Declan Rice': 3.8, 'Alexis Mac Allister': 3.6, 'Yves Bissouma': 3.5
                },
                'Interceptions per 90': {
                    'João Palhinha': 2.6, 'Rodri': 2.4, 'William Saliba': 2.2, 'Virgil van Dijk': 2.1, 'Malo Gusto': 2.0
                },
                'Aerials Won per 90': {
                    'James Tarkowski': 5.2, 'Dan Burn': 5.0, 'Harry Maguire': 4.9, 'Ivan Toney': 4.7, 'Ollie Watkins': 4.6
                },
                'Shot-Creating Actions (SCA) per 90': {
                    'Kevin De Bruyne': 6.8, 'Bruno Fernandes': 6.1, 'Phil Foden': 5.8, 'Cole Palmer': 5.5, 'Bukayo Saka': 5.4
                },
                'Goal-Creating Actions (GCA) per 90': {
                    'Kevin De Bruyne': 1.3, 'Bruno Fernandes': 1.2, 'Leandro Trossard': 1.1, 'Mohamed Salah': 1.05, 'Bukayo Saka': 1.02
                },
                'Carries into Final Third per 90': {
                    'Jérémy Doku': 7.8, 'Jack Grealish': 7.2, 'Michael Olise': 7.0, 'Bukayo Saka': 6.8, 'Phil Foden': 6.5
                },
                'Progressive Carries per 90': {
                    'Jérémy Doku': 13.8, 'Jack Grealish': 13.2, 'Eberechi Eze': 13.0, 'Mohamed Salah': 12.8, 'Phil Foden': 12.5
                },
                'Pass Completion %': {
                    'Manuel Akanji': 94.2, 'Rodri': 93.8, 'John Stones': 93.2, 'William Saliba': 93.0, 'Nathan Aké': 92.8
                },
                'Shots on Target %': {
                    'Cole Palmer': 59.0, 'Erling Haaland': 56.0, 'Harry Kane': 53.0, 'Ollie Watkins': 51.0, 'Dominic Solanke': 49.0
                }
            },
            '2024': {
                'Goals per 90': { 'Cole Palmer': 0.85, 'Ollie Watkins': 0.70, 'Dominic Solanke': 0.65, 'Phil Foden': 0.60, 'Alexander Isak': 0.59 },
                'xG per 90': { 'Cole Palmer': 0.78, 'Ollie Watkins': 0.68, 'Dominic Solanke': 0.62, 'Alexander Isak': 0.58, 'Darwin Núñez': 0.55 },
                'Assists per 90': { 'Cole Palmer': 0.45, 'Martin Ødegaard': 0.42, 'Leandro Trossard': 0.40, 'Bruno Fernandes': 0.39, 'Morgan Gibbs-White': 0.37 },
                'Progressive Passes per 90': { 'Rodri': 9.5, 'Kevin De Bruyne': 9.1, 'Bruno Guimarães': 8.8, 'Pascal Groß': 8.6, 'Trent Alexander-Arnold': 8.5 },
                'Dribbles per 90': { 'Eberechi Eze': 3.8, 'Jérémy Doku': 3.6, 'Solly March': 3.3, 'Cole Palmer': 3.2, 'Michael Olise': 3.1 },
                'Tackles per 90': { 'João Palhinha': 3.9, 'Yves Bissouma': 3.7, 'Declan Rice': 3.5, 'Alexis Mac Allister': 3.3, 'Bruno Guimarães': 3.2 },
                'Interceptions per 90': { 'João Palhinha': 2.5, 'Rodri': 2.3, 'Malo Gusto': 2.1, 'William Saliba': 2.0, 'Virgil van Dijk': 1.9 },
                'Aerials Won per 90': { 'Dan Burn': 5.0, 'James Tarkowski': 4.8, 'Harry Maguire': 4.6, 'Ivan Toney': 4.4, 'Ollie Watkins': 4.3 },
                'Shot-Creating Actions (SCA) per 90': { 'Kevin De Bruyne': 6.5, 'Bruno Fernandes': 5.8, 'Phil Foden': 5.5, 'Cole Palmer': 5.2, 'Bukayo Saka': 5.1 },
                'Goal-Creating Actions (GCA) per 90': { 'Kevin De Bruyne': 1.2, 'Bruno Fernandes': 1.1, 'Leandro Trossard': 1.05, 'Mohamed Salah': 1.0, 'Bukayo Saka': 0.98 },
                'Carries into Final Third per 90': { 'Jérémy Doku': 7.5, 'Jack Grealish': 7.0, 'Michael Olise': 6.8, 'Bukayo Saka': 6.5, 'Phil Foden': 6.3 },
                'Progressive Carries per 90': { 'Jérémy Doku': 13.5, 'Jack Grealish': 13.0, 'Eberechi Eze': 12.8, 'Mohamed Salah': 12.5, 'Phil Foden': 12.0 },
                'Pass Completion %': { 'Manuel Akanji': 94.0, 'Rodri': 93.5, 'John Stones': 93.0, 'William Saliba': 92.8, 'Nathan Aké': 92.5 },
                'Shots on Target %': { 'Cole Palmer': 58.0, 'Erling Haaland': 55.0, 'Harry Kane': 52.5, 'Ollie Watkins': 50.0, 'Dominic Solanke': 48.0 }
            },
            '2023': {
                'Goals per 90': { 'Erling Haaland': 0.94, 'Harry Kane': 0.88, 'Mohamed Salah': 0.63, 'Callum Wilson': 0.60, 'Marcus Rashford': 0.58 },
                'xG per 90': { 'Erling Haaland': 0.87, 'Harry Kane': 0.67, 'Darwin Núñez': 0.64, 'Marcus Rashford': 0.54, 'Callum Wilson': 0.53 },
                'Assists per 90': { 'Kevin De Bruyne': 0.51, 'Leandro Trossard': 0.46, 'Bukayo Saka': 0.38, 'Michael Olise': 0.38, 'Riyad Mahrez': 0.38 },
                'Progressive Passes per 90': { 'Rodri': 9.2, 'Lewis Dunk': 8.9, 'Luke Shaw': 8.5, 'Thiago Silva': 8.2, 'Rúben Neves': 8.0 },
                'Dribbles per 90': { 'Adama Traoré': 4.1, 'Allan Saint-Maximin': 4.0, 'Eberechi Eze': 3.4, 'Solly March': 3.1, 'Gabriel Martinelli': 3.0 },
                'Tackles per 90': { 'Tyler Adams': 3.6, 'João Palhinha': 3.5, 'Alex Iwobi': 3.2, 'Saïd Benrahma': 3.1, 'Casemiro': 3.0 },
                'Interceptions per 90': { 'João Palhinha': 2.2, 'Ibrahima Konaté': 2.1, 'Tyler Adams': 2.0, 'Diogo Dalot': 1.9, 'Moises Caicedo': 1.8 },
                'Aerials Won per 90': { 'Dan Burn': 4.7, 'James Tarkowski': 4.5, 'Harry Maguire': 4.4, 'Ollie Watkins': 4.2, 'Dominic Calvert-Lewin': 4.1 },
                'Shot-Creating Actions (SCA) per 90': { 'Kevin De Bruyne': 6.0, 'Bruno Fernandes': 5.2, 'Bukayo Saka': 4.9, 'Jack Grealish': 4.8, 'Mohamed Salah': 4.7 },
                'Goal-Creating Actions (GCA) per 90': { 'Kevin De Bruyne': 1.05, 'Bruno Fernandes': 0.98, 'Bukayo Saka': 0.95, 'Leandro Trossard': 0.92, 'Mohamed Salah': 0.90 },
                'Carries into Final Third per 90': { 'Jack Grealish': 6.5, 'Solly March': 6.2, 'Bukayo Saka': 6.1, 'Gabriel Martinelli': 5.9, 'Phil Foden': 5.8 },
                'Progressive Carries per 90': { 'Jack Grealish': 12.1, 'Mohamed Salah': 11.8, 'Eberechi Eze': 11.5, 'Allan Saint-Maximin': 11.2, 'Phil Foden': 11.0 },
                'Pass Completion %': { 'Manuel Akanji': 93.3, 'John Stones': 93.1, 'Nathan Aké': 92.5, 'Rodri': 91.5, 'Lewis Dunk': 91.2 },
                'Shots on Target %': { 'Erling Haaland': 55.4, 'Son Heung-min': 50.0, 'Harry Kane': 47.9, 'Kelechi Iheanacho': 46.2, 'Mohamed Salah': 46.0 }
            },
            '2022': {
                'Goals per 90': { 'Mohamed Salah': 0.77, 'Son Heung-min': 0.69, 'Cristiano Ronaldo': 0.63, 'Harry Kane': 0.62, 'Diogo Jota': 0.60 },
                'xG per 90': { 'Mohamed Salah': 0.72, 'Cristiano Ronaldo': 0.68, 'Diogo Jota': 0.65, 'Kevin De Bruyne': 0.58, 'Harry Kane': 0.57 },
                'Assists per 90': { 'Paul Pogba': 0.76, 'Trent Alexander-Arnold': 0.44, 'Mason Mount': 0.43, 'Kevin De Bruyne': 0.41, 'Jarrod Bowen': 0.38 },
                'Progressive Passes per 90': { 'Rúben Neves': 8.8, 'Jack Grealish': 8.5, 'Trent Alexander-Arnold': 8.2, 'Rodri': 8.0, 'Jorginho': 7.9 },
                'Dribbles per 90': { 'Adama Traoré': 4.5, 'Allan Saint-Maximin': 4.2, 'Riyad Mahrez': 3.8, 'Wilfried Zaha': 3.6, 'Jack Grealish': 3.5 },
                'Tackles per 90': { 'João Palhinha': 3.8, 'Rodrigo Bentancur': 3.5, 'Moises Caicedo': 3.4, 'Declan Rice': 3.3, 'N’Golo Kanté': 3.2 },
                'Interceptions per 90': { 'Rúben Dias': 2.5, 'Declan Rice': 2.4, 'Ethan Pinnock': 2.3, 'Ben White': 2.2, 'Conor Coady': 2.1 },
                'Aerials Won per 90': { 'Dominic Calvert-Lewin': 5.1, 'Chris Wood': 4.9, 'James Tarkowski': 4.8, 'Harry Maguire': 4.5, 'Ivan Toney': 4.3 },
                'Shot-Creating Actions (SCA) per 90': { 'Kevin De Bruyne': 6.2, 'Bruno Fernandes': 5.8, 'Jack Grealish': 5.5, 'Mohamed Salah': 5.4, 'Bukayo Saka': 5.1 },
                'Goal-Creating Actions (GCA) per 90': { 'Kevin De Bruyne': 1.15, 'Bruno Fernandes': 1.08, 'Mohamed Salah': 1.02, 'Jack Grealish': 0.95, 'Leandro Trossard': 0.91 },
                'Carries into Final Third per 90': { 'Jack Grealish': 7.2, 'Mohamed Salah': 6.9, 'Gabriel Martinelli': 6.5, 'Bukayo Saka': 6.3, 'Eberechi Eze': 6.0 },
                'Progressive Carries per 90': { 'Jack Grealish': 12.8, 'Mohamed Salah': 12.5, 'Eberechi Eze': 12.1, 'Allan Saint-Maximin': 11.9, 'Phil Foden': 11.5 },
                'Pass Completion %': { 'John Stones': 94.1, 'Rúben Dias': 93.8, 'Nathan Aké': 93.5, 'Rodri': 92.8, 'Joël Matip': 92.4 },
                'Shots on Target %': { 'Son Heung-min': 52.3, 'Erling Haaland': 50.9, 'Ivan Toney': 49.5, 'Cristiano Ronaldo': 48.7, 'Diogo Jota': 48.0 }
            },
        };
        const pmBenchmarks = {
            'Forward': {
                '2025': { stat1: 0.85, stat2: 0.81, stat3: 0.50, stat1Name: 'Goals/90', stat2Name: 'xG/90', stat3Name: 'Assists/90' },
                '2024': { stat1: 0.78, stat2: 0.72, stat3: 0.45, stat1Name: 'Goals/90', stat2Name: 'xG/90', stat3Name: 'Assists/90' },
                '2023': { stat1: 0.75, stat2: 0.65, stat3: 0.40, stat1Name: 'Goals/90', stat2Name: 'xG/90', stat3Name: 'Assists/90' },
                '2022': { stat1: 0.72, stat2: 0.61, stat3: 0.38, stat1Name: 'Goals/90', stat2Name: 'xG/90', stat3Name: 'Assists/90' },
            },
            'Midfielder': {
                '2025': { stat1: 9.5, stat2: 3.5, stat3: 3.8, stat1Name: 'Prog. Passes/90', stat2Name: 'Dribbles/90', stat3Name: 'Tackles/90' },
                '2024': { stat1: 9.0, stat2: 3.2, stat3: 3.5, stat1Name: 'Prog. Passes/90', stat2Name: 'Dribbles/90', stat3Name: 'Tackles/90' },
                '2023': { stat1: 8.5, stat2: 3.0, stat3: 3.2, stat1Name: 'Prog. Passes/90', stat2Name: 'Dribbles/90', stat3Name: 'Tackles/90' },
                '2022': { stat1: 8.2, stat2: 2.8, stat3: 3.0, stat1Name: 'Prog. Passes/90', stat2Name: 'Dribbles/90', stat3Name: 'Tackles/90' },
            },
            'Defender': {
                '2025': { stat1: 3.9, stat2: 2.2, stat3: 4.8, stat1Name: 'Tackles/90', stat2Name: 'Interceptions/90', stat3Name: 'Aerials Won/90' },
                '2024': { stat1: 3.7, stat2: 2.0, stat3: 4.5, stat1Name: 'Tackles/90', stat2Name: 'Interceptions/90', stat3Name: 'Aerials Won/90' },
                '2023': { stat1: 3.5, stat2: 1.9, stat3: 4.2, stat1Name: 'Tackles/90', stat2Name: 'Interceptions/90', stat3Name: 'Aerials Won/90' },
                '2022': { stat1: 3.3, stat2: 1.8, stat3: 4.0, stat1Name: 'Tackles/90', stat2Name: 'Interceptions/90', stat3Name: 'Aerials Won/90' },
            }
        };
        const statTypes = [
            'Goals per 90', 'xG per 90', 'Assists per 90', 'Progressive Passes per 90',
            'Dribbles per 90', 'Tackles per 90', 'Interceptions per 90', 'Aerials Won per 90',
            'Shot-Creating Actions (SCA) per 90', 'Goal-Creating Actions (GCA) per 90',
            'Carries into Final Third per 90', 'Progressive Carries per 90', 'Pass Completion %',
            'Shots on Target %'
        ];
        const baseLeague = 'Premier League';
        let adjustedValue = 0;
        let factorsChartInstance = null;
        let adjustmentChartInstance = null;
        let comparisonChartInstance = null;

        function calculateDifficultyScores(plYear) {
            const uefaWeight = parseFloat(document.getElementById('uefaWeight').value) / 100;
            const compWeight = parseFloat(document.getElementById('compWeight').value) / 100;
            const baseUefa = leagueData[baseLeague][plYear].uefaCoeff;
            const baseComp = leagueData[baseLeague][plYear].intraComp;
            for (const league in leagueData) {
                 for (const year in leagueData[league]) {
                    const data = leagueData[league][year];
                    const uefaRatio = data.uefaCoeff / baseUefa;
                    const compRatio = data.intraComp / baseComp;
                    const faf = (uefaRatio * uefaWeight) + (compRatio * compWeight);
                    data.uefaRatio = uefaRatio;
                    data.compRatio = compRatio;
                    data.faf = faf;
                }
            }
        }
        function populateLeagueSelector() {
            const selector = document.getElementById('league');
            selector.innerHTML = '';
            Object.keys(leagueData).filter(l => l !== baseLeague).forEach(league => {
                const option = document.createElement('option');
                option.value = league;
                option.textContent = league;
                selector.appendChild(option);
            });
        }
        function populateStatSelectors() {
            const statSelector = document.getElementById('statType');
            statSelector.innerHTML = '';
            statTypes.forEach(stat => {
                const option = document.createElement('option');
                option.value = stat;
                option.textContent = stat;
                statSelector.appendChild(option);
            });
        }
        function updatePmInputs(position) {
            const pmInputsDiv = document.getElementById('pmInputs');
            const benchmark = pmBenchmarks[position][document.getElementById('rawStatYear').value];
            
            pmInputsDiv.innerHTML = `
                <h3 class="text-md font-semibold text-slate-700 dark:text-slate-300 mb-2">Playstyle Multiplier (PM) Inputs</h3>
                <p class="text-sm text-slate-600 dark:text-slate-400 mb-2">Input the player's per 90 stats for their position to calculate their stylistic fit. The benchmark is for a top PL player in the same season as the raw stats.</p>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label for="pmStat1" class="block text-sm font-medium text-slate-700 dark:text-slate-300">${benchmark.stat1Name}</label>
                        <input type="number" name="pmStat1" id="pmStat1" step="0.01" value="0" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-slate-300 rounded-md dark:bg-slate-700 dark:text-white dark:border-slate-600">
                    </div>
                    <div>
                        <label for="pmStat2" class="block text-sm font-medium text-slate-700 dark:text-slate-300">${benchmark.stat2Name}</label>
                        <input type="number" name="pmStat2" id="pmStat2" step="0.01" value="0" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-slate-300 rounded-md dark:bg-slate-700 dark:text-white dark:border-slate-600">
                    </div>
                    <div>
                        <label for="pmStat3" class="block text-sm font-medium text-slate-700 dark:text-slate-300">${benchmark.stat3Name}</label>
                        <input type="number" name="pmStat3" id="pmStat3" step="0.01" value="0" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-slate-300 rounded-md dark:bg-slate-700 dark:text-white dark:border-slate-600">
                    </div>
                </div>
            `;
        }
        function updateChartColors() {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const fontColor = isDarkMode ? '#e2e8f0' : '#475569';
            if (factorsChartInstance) {
                factorsChartInstance.options.scales.y.ticks.color = fontColor;
                factorsChartInstance.options.scales.x.ticks.color = fontColor;
                factorsChartInstance.options.scales.y.title.color = fontColor;
                factorsChartInstance.update();
            }
            if (adjustmentChartInstance) {
                adjustmentChartInstance.options.scales.y.ticks.color = fontColor;
                adjustmentChartInstance.options.scales.x.ticks.color = fontColor;
                adjustmentChartInstance.options.scales.y.title.color = fontColor;
                adjustmentChartInstance.update();
            }
            if (comparisonChartInstance) {
                comparisonChartInstance.options.scales.x.ticks.color = fontColor;
                comparisonChartInstance.options.scales.y.ticks.color = fontColor;
                comparisonChartInstance.options.scales.x.title.color = fontColor;
                comparisonChartInstance.update();
            }
        }
        function renderCharts(plYear) {
            if (factorsChartInstance) factorsChartInstance.destroy();
            if (adjustmentChartInstance) adjustmentChartInstance.destroy();

            const leagues = Object.keys(leagueData);
            const uefaWeight = parseFloat(document.getElementById('uefaWeight').value) / 100;
            const compWeight = parseFloat(document.getElementById('compWeight').value) / 100;

            const factorChartCtx = document.getElementById('factorsChart').getContext('2d');
            factorsChartInstance = new Chart(factorChartCtx, {
                type: 'bar',
                data: {
                    labels: leagues,
                    datasets: [
                        { label: 'Normalized UEFA Coefficient', data: leagues.map(l => leagueData[l][plYear].uefaRatio), backgroundColor: `rgba(54, 162, 235, ${uefaWeight})`, borderColor: `rgba(54, 162, 235, 1)`, borderWidth: 1 },
                        { label: 'Normalized Competitiveness', data: leagues.map(l => leagueData[l][plYear].compRatio), backgroundColor: `rgba(255, 99, 132, ${compWeight})`, borderColor: `rgba(255, 99, 132, 1)`, borderWidth: 1 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: false }, tooltip: { mode: 'index', intersect: false } }, scales: { y: { beginAtZero: true, suggestedMax: 1.1, title: { display: true, text: 'Normalized Score (PL = 1.0)' } }, x: { grid: { display: false } } } }
            });
            const adjustmentChartCtx = document.getElementById('adjustmentChart').getContext('2d');
            adjustmentChartInstance = new Chart(adjustmentChartCtx, {
                type: 'bar',
                data: {
                    labels: leagues.filter(l => l !== baseLeague),
                    datasets: [{ label: 'Adjustment Factor', data: leagues.filter(l => l !== baseLeague).map(l => leagueData[l][plYear].faf), backgroundColor: leagues.filter(l => l !== baseLeague).map(l => leagueData[l][plYear].color), borderColor: leagues.filter(l => l !== baseLeague).map(l => leagueData[l][plYear].color.replace('0.7', '1')), borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: false } }, scales: { y: { beginAtZero: true, suggestedMax: 1.0, title: { display: true, text: 'Adjustment Factor' } }, x: { grid: { display: false } } } }
            });
            updateChartColors();
        }
        function renderPlayerComparisonChart(playerName, statType, rawValue, adjustedValue, plYear) {
            if (comparisonChartInstance) comparisonChartInstance.destroy();

            const topPlayers = topPLPlayersData[plYear][statType];
            if (!topPlayers) {
                 const ctx = document.getElementById('comparisonChart').getContext('2d');
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                 return;
            }
            const labels = [playerName, ...Object.keys(topPlayers)];
            const rawDataValues = [rawValue, ...Object.values(topPlayers)];
            const adjustedDataValues = [adjustedValue, ...Array(Object.keys(topPlayers).length).fill(0)];
            const comparisonChartCtx = document.getElementById('comparisonChart').getContext('2d');
            comparisonChartInstance = new Chart(comparisonChartCtx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Raw Stat', data: rawDataValues, backgroundColor: 'rgba(252, 211, 77, 0.8)', borderColor: 'rgba(252, 211, 77, 1)', borderWidth: 1 },
                        { label: 'Adjusted Stat', data: adjustedDataValues, backgroundColor: 'rgba(59, 130, 246, 0.6)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: true }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.parsed.x.toFixed(2)}` } }, title: { display: false } }, scales: { x: { beginAtZero: true, title: { display: true, text: statType } }, y: { grid: { display: false } } } }
            });
            updateChartColors();
        }

        // NEW: Advanced PM Calculation with Tiered Exponents
        function calculatePM(position, rawStatYear, lmForEra, stat1, stat2, stat3) {
            const benchmark = pmBenchmarks[position][rawStatYear];
            if (!benchmark) return { pm: 1.0, averagePQR: 1.0, pqr1: 1.0, pqr2: 1.0, pqr3: 1.0, fitTier: 'N/A' };

            const adjustedStat1 = stat1 * lmForEra;
            const adjustedStat2 = stat2 * lmForEra;
            const adjustedStat3 = stat3 * lmForEra;

            const pqr1 = adjustedStat1 / benchmark.stat1;
            const pqr2 = adjustedStat2 / benchmark.stat2;
            const pqr3 = adjustedStat3 / benchmark.stat3;

            const averagePQR = (pqr1 + pqr2 + pqr3) / 3;

            let exponent;
            let fitTier;
            if (averagePQR >= 1.20) {
                exponent = 1.30;
                fitTier = 'Exceptional Fit';
            } else if (averagePQR >= 1.0) {
                exponent = 1.15;
                fitTier = 'Good Fit';
            } else if (averagePQR >= 0.80) {
                exponent = 1.20;
                fitTier = 'Questionable Fit';
            } else {
                exponent = 1.40;
                fitTier = 'Poor Fit';
            }
            
            const pm = Math.pow(averagePQR, exponent);
            return { pm, averagePQR, pqr1, pqr2, pqr3, fitTier };
        }

        function getMultipliers() {
            const selectedLeague = document.getElementById('league').value;
            const plYear = document.getElementById('plYear').value;
            const rawStatYear = document.getElementById('rawStatYear').value;
            const uefaWeight = parseFloat(document.getElementById('uefaWeight').value) / 100;
            const compWeight = parseFloat(document.getElementById('compWeight').value) / 100;
            const position = document.getElementById('position').value;
            const pmStat1 = parseFloat(document.getElementById('pmStat1').value);
            const pmStat2 = parseFloat(document.getElementById('pmStat2').value);
            const pmStat3 = parseFloat(document.getElementById('pmStat3').value);
            const potential = parseInt(document.getElementById('potential').value);
            
            if (isNaN(pmStat1) || isNaN(pmStat2) || isNaN(pmStat3)) return null;

            // LM for final stat projection (Original League [rawStatYear] -> PL [plYear])
            const selectedLeagueDataFinal = leagueData[selectedLeague][rawStatYear];
            const baseLeagueDataFinal = leagueData[baseLeague][plYear];
            const uefaRatioFinal = selectedLeagueDataFinal.uefaCoeff / baseLeagueDataFinal.uefaCoeff;
            const compRatioFinal = selectedLeagueDataFinal.intraComp / baseLeagueDataFinal.intraComp;
            const lm = (uefaRatioFinal * uefaWeight) + (compRatioFinal * compWeight);

            // LM for PM era-adjustment (Original League [rawStatYear] -> PL [rawStatYear])
            const selectedLeagueDataEra = leagueData[selectedLeague][rawStatYear];
            const baseLeagueDataEra = leagueData[baseLeague][rawStatYear];
            const uefaRatioEra = selectedLeagueDataEra.uefaCoeff / baseLeagueDataEra.uefaCoeff;
            const compRatioEra = selectedLeagueDataEra.intraComp / baseLeagueDataEra.intraComp;
            const lmForEra = (uefaRatioEra * uefaWeight) + (compRatioEra * compWeight);
            
            const pmDetails = calculatePM(position, rawStatYear, lmForEra, pmStat1, pmStat2, pmStat3);
            const potm = 1 + (potential - 3) * 0.05;

            const potentialMap = { 1: 'Low', 2: 'Below Avg', 3: 'Average', 4: 'Above Avg', 5: 'High' };
            const potmTier = potentialMap[potential];

            return { lm, pmDetails, potm, potmTier };
        }

        function performCalculation() {
            const rawValue = parseFloat(document.getElementById('statValue').value);
            const statType = document.getElementById('statType').value;
            const plYear = document.getElementById('plYear').value;
            const rawStatYear = document.getElementById('rawStatYear').value;
            const position = document.getElementById('position').value;
            const pmBreakdownDiv = document.getElementById('pmBreakdown');
            const potmBreakdownDiv = document.getElementById('potmBreakdown');
            
            if (isNaN(rawValue) || !statType) {
                document.getElementById('adjustedValue').textContent = '-';
                document.getElementById('equivalentText').textContent = 'Please fill in all fields.';
                pmBreakdownDiv.classList.add('hidden');
                potmBreakdownDiv.classList.add('hidden');
                return;
            }

            const multipliers = getMultipliers();
            if (!multipliers) {
                 document.getElementById('adjustedValue').textContent = '-';
                 document.getElementById('equivalentText').textContent = 'Please input valid PM stats.';
                 pmBreakdownDiv.classList.add('hidden');
                 potmBreakdownDiv.classList.add('hidden');
                 return;
            }

            const { lm, pmDetails, potm, potmTier } = multipliers;
            const pm = pmDetails.pm;
            adjustedValue = rawValue * lm * pm * potm;
            
            document.getElementById('adjustedValue').textContent = adjustedValue.toFixed(2);
            document.getElementById('lmValue').textContent = lm.toFixed(3);
            document.getElementById('pmValue').textContent = pm.toFixed(3);
            document.getElementById('potmValue').textContent = potm.toFixed(3);
            
            const benchmark = pmBenchmarks[position][rawStatYear];
            pmBreakdownDiv.innerHTML = `
                <p>↳ <strong>Fit Assessment:</strong> <span class="font-semibold text-amber-200">${pmDetails.fitTier}</span></p>
                <p class="text-xs text-blue-200/90 mt-1"> (Based on Average PQR of <strong>${pmDetails.averagePQR.toFixed(3)}</strong>)</p>
                <div class="mt-2 text-xs text-blue-200/80 space-y-0.5">
                    <p> • ${benchmark.stat1Name} PQR: <strong>${pmDetails.pqr1.toFixed(2)}</strong></p>
                    <p> • ${benchmark.stat2Name} PQR: <strong>${pmDetails.pqr2.toFixed(2)}</strong></p>
                    <p> • ${benchmark.stat3Name} PQR: <strong>${pmDetails.pqr3.toFixed(2)}</strong></p>
                </div>
            `;
            pmBreakdownDiv.classList.remove('hidden');

            potmBreakdownDiv.innerHTML = `
                <p>↳ <strong>Potential Assessment:</strong> <span class="font-semibold text-amber-200">${potmTier}</span></p>
            `;
            potmBreakdownDiv.classList.remove('hidden');

            document.getElementById('equivalentText').textContent = `is the Premier League equivalent for ${statType}.`;
            renderPlayerComparisonChart('Selected Player', statType, rawValue, adjustedValue, plYear);
        }
        
        function performReverseCalculation() {
             const targetValue = parseFloat(document.getElementById('targetStatValue').value);
             const selectedLeague = document.getElementById('league').value;
             const rawStatYear = document.getElementById('rawStatYear').value;
             const position = document.getElementById('position').value;
             const reversePmBreakdownDiv = document.getElementById('reversePmBreakdown');
             const reversePotmBreakdownDiv = document.getElementById('reversePotmBreakdown');


             if (isNaN(targetValue)) {
                 document.getElementById('requiredRawValue').textContent = '-';
                 reversePmBreakdownDiv.classList.add('hidden');
                 reversePotmBreakdownDiv.classList.add('hidden');
                 return;
             }

             const multipliers = getMultipliers();
             if (!multipliers) {
                  document.getElementById('requiredRawValue').textContent = '-';
                  reversePmBreakdownDiv.classList.add('hidden');
                  reversePotmBreakdownDiv.classList.add('hidden');
                  return;
             }

             const { lm, pmDetails, potm, potmTier } = multipliers;
             const totalMultiplier = lm * pmDetails.pm * potm;

             if (totalMultiplier === 0) {
                 document.getElementById('requiredRawValue').textContent = '∞';
                 return;
             }
             
             const requiredRawValue = targetValue / totalMultiplier;

             document.getElementById('requiredRawValue').textContent = requiredRawValue.toFixed(2);
             document.getElementById('requiredLeagueText').textContent = `in ${selectedLeague}.`;

             // Populate justification
             document.getElementById('reverseLmValue').textContent = lm.toFixed(3);
             document.getElementById('reversePmValue').textContent = pmDetails.pm.toFixed(3);
             document.getElementById('reversePotmValue').textContent = potm.toFixed(3);
             
             const benchmark = pmBenchmarks[position][rawStatYear];
             reversePmBreakdownDiv.innerHTML = `
                <p>↳ <strong>Fit Assessment:</strong> <span class="font-semibold">${pmDetails.fitTier}</span></p>
                <p class="mt-1"> (Based on Avg PQR of <strong>${pmDetails.averagePQR.toFixed(3)}</strong>)</p>
                <div class="mt-2 space-y-0.5">
                    <p> • ${benchmark.stat1Name} PQR: <strong>${pmDetails.pqr1.toFixed(2)}</strong></p>
                    <p> • ${benchmark.stat2Name} PQR: <strong>${pmDetails.pqr2.toFixed(2)}</strong></p>
                    <p> • ${benchmark.stat3Name} PQR: <strong>${pmDetails.pqr3.toFixed(2)}</strong></p>
                </div>
            `;
             reversePmBreakdownDiv.classList.remove('hidden');

             reversePotmBreakdownDiv.innerHTML = `
                <p>↳ <strong>Potential Assessment:</strong> <span class="font-semibold">${potmTier}</span></p>
            `;
             reversePotmBreakdownDiv.classList.remove('hidden');
        }
        
        // Event Listeners Setup
        const calculateBtn = document.getElementById('calculateBtn');
        const calculateReverseBtn = document.getElementById('calculateReverseBtn');
        const plYearSelector = document.getElementById('plYear');
        const rawStatYearSelector = document.getElementById('rawStatYear');
        const uefaWeightSlider = document.getElementById('uefaWeight');
        const compWeightSlider = document.getElementById('compWeight');
        const uefaWeightValueSpan = document.getElementById('uefaWeightValue');
        const compWeightValueSpan = document.getElementById('compWeightValue');
        const themeToggle = document.getElementById('themeToggle');
        const positionSelector = document.getElementById('position');
        const potentialSlider = document.getElementById('potential');
        const potentialValueSpan = document.getElementById('potentialValue');

        if (potentialSlider) {
            potentialSlider.addEventListener('input', () => {
                const potential = parseInt(potentialSlider.value);
                const potentialMap = { 1: 'Low (0.90x)', 2: 'Below Avg (0.95x)', 3: 'Average (1.00x)', 4: 'Above Avg (1.05x)', 5: 'High (1.10x)' };
                potentialValueSpan.textContent = potentialMap[potential];
            });
        }
        if (uefaWeightSlider && compWeightSlider) {
             const updateWeights = () => {
                let uefaWeight = parseInt(uefaWeightSlider.value);
                let compWeight = 100 - uefaWeight;
                compWeightSlider.value = compWeight;
                uefaWeightValueSpan.textContent = uefaWeight;
                compWeightValueSpan.textContent = compWeight;
                calculateDifficultyScores(document.getElementById('plYear').value);
                renderCharts(document.getElementById('plYear').value);
            };
            uefaWeightSlider.addEventListener('input', updateWeights);
            compWeightSlider.addEventListener('input', () => {
                let compWeight = parseInt(compWeightSlider.value);
                let uefaWeight = 100 - compWeight;
                uefaWeightSlider.value = uefaWeight;
                uefaWeightValueSpan.textContent = uefaWeight;
                compWeightValueSpan.textContent = compWeight;
                calculateDifficultyScores(document.getElementById('plYear').value);
                renderCharts(document.getElementById('plYear').value);
            });
        }
        
        const yearChangeHandler = () => {
            const newYear = document.getElementById('plYear').value;
            calculateDifficultyScores(newYear);
            renderCharts(newYear);
            updatePmInputs(document.getElementById('position').value);
        };
        
        if (calculateBtn) calculateBtn.addEventListener('click', performCalculation);
        if (calculateReverseBtn) calculateReverseBtn.addEventListener('click', performReverseCalculation);
        if (plYearSelector) plYearSelector.addEventListener('change', yearChangeHandler);
        if (rawStatYearSelector) rawStatYearSelector.addEventListener('change', yearChangeHandler);
        if (positionSelector) positionSelector.addEventListener('change', (e) => updatePmInputs(e.target.value));
        
        // Theme Toggle Logic
        const isSystemDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const storedTheme = localStorage.getItem('theme');
        if (storedTheme === 'dark' || (storedTheme === null && isSystemDarkMode)) {
            document.documentElement.classList.add('dark');
            document.getElementById('sunIcon').classList.remove('hidden');
            document.getElementById('moonIcon').classList.add('hidden');
        } else {
            document.getElementById('moonIcon').classList.remove('hidden');
            document.getElementById('sunIcon').classList.add('hidden');
        }
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('sunIcon').classList.toggle('hidden', !isDark);
            document.getElementById('moonIcon').classList.toggle('hidden', isDark);
            updateChartColors();
        });

        // Initial setup
        calculateDifficultyScores(plYearSelector.value);
        populateLeagueSelector();
        populateStatSelectors();
        renderCharts(plYearSelector.value);
        updatePmInputs(positionSelector.value);
    });
</script>
</body>
</html>